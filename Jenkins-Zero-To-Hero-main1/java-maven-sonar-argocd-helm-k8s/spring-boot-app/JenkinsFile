pipeline {
  agent any

  environment {
    // Folder that contains pom.xml (your screenshots)
    APP_DIR = 'Jenkins-Zero-To-Hero-main1/java-maven-sonar-argocd-helm-k8s/spring-boot-app'

    DOCKER_IMAGE      = "induja1408/portfolio-app:${BUILD_NUMBER}"
    SONARQUBE_SERVER  = 'sonarqube-server'                       // Jenkins > Manage Jenkins > System
    SONAR_HOST_URL    = 'http://18.234.42.66:9000'               // SonarQube VM
    NEXUS_REPO_URL    = 'http://18.234.42.66:8081/repository/maven-releases/' // Nexus VM
  }

  options { timestamps() }

  stages {

    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[url: 'https://github.com/Induja1408/portfolio-project.git']]
        ])
        sh 'echo "Checked out:" && git log -1 --oneline'
      }
    }

    stage('Normalize project layout (workspace only)') {
      steps {
        dir("${APP_DIR}") {
          sh '''
            set -eu

            # Ensure Maven-standard folders exist
            mkdir -p src/main/java/com/abhishek/demo
            mkdir -p src/main/resources/static

            # Move main class if it sits directly under src/
            if [ -f src/StartApplication.java ]; then
              echo "Moving StartApplication.java into src/main/java/com/abhishek/demo/"
              mv -f src/StartApplication.java src/main/java/com/abhishek/demo/StartApplication.java
            fi

            # Move static files if present
            [ -f src/index.html ] && mv -f src/index.html src/main/resources/static/index.html || true
            [ -f src/main.css   ] && mv -f src/main.css   src/main/resources/static/main.css   || true

            # Handle application.properties (fix typo application.prperties -> application.properties)
            if   [ -f src/application.properties ]; then
              mv -f src/application.properties src/main/resources/application.properties
            elif [ -f src/application.prperties ]; then
              mv -f src/application.prperties  src/main/resources/application.properties
            fi

            # Remove any stray file that might confuse Jenkins/Git steps
            [ -f src/JenkinsFile.txt ] && rm -f src/JenkinsFile.txt || true

            echo "Final tree (top 3 levels):"
            find . -maxdepth 3 -type d -print | sed -e "s|^./||"
          '''
        }
      }
    }

    stage('Build & Unit Tests') {
      steps {
        dir("${APP_DIR}") {
          sh 'mvn -B -DskipTests=false clean package'
        }
      }
      post {
        always {
          dir("${APP_DIR}") {
            junit '**/target/surefire-reports/*.xml'
            archiveArtifacts artifacts: 'target/*.jar', onlyIfSuccessful: true
          }
        }
      }
    }

    stage('SonarQube Analysis') {
      environment { SONAR_TOKEN = credentials('sonarqube-token') }
      steps {
        dir("${APP_DIR}") {
          withSonarQubeEnv("${SONARQUBE_SERVER}") {
            sh '''
              mvn sonar:sonar \
                -Dsonar.projectKey=portfolio-app \
                -Dsonar.host.url='"${SONAR_HOST_URL}"' \
                -Dsonar.login=$SONAR_TOKEN
            '''
          }
        }
      }
    }

    stage('Upload JAR to Nexus') {
      environment { NEXUS = credentials('nexus-cred') }
      steps {
        dir("${APP_DIR}") {
          sh '''
            mvn -B -DskipTests=true deploy \
              -DaltDeploymentRepository=nexus::default::'"${NEXUS_REPO_URL}"' \
              -DrepositoryId=nexus \
              -Dusername=$NEXUS_USR \
              -Dpassword=$NEXUS_PSW
          '''
        }
      }
    }

    stage('Build Docker image') {
      steps {
        dir("${APP_DIR}") {
          sh 'docker build -t ${DOCKER_IMAGE} .'
        }
      }
    }

    stage('Push Docker image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-cred', usernameVariable: 'DUSER', passwordVariable: 'DPASS')]) {
          sh '''
            echo "$DPASS" | docker login -u "$DUSER" --password-stdin
            docker push ${DOCKER_IMAGE}
          '''
        }
      }
    }

    stage('Run container (port 8000)') {
      steps {
        sh '''
          docker rm -f portfolio-app || true
          docker run -d --name portfolio-app -p 8000:8080 ${DOCKER_IMAGE}
        '''
      }
    }
  }

  post {
    success { echo '✅ Done. App should be at http://<jenkins-node-ip>:8000' }
    failure { echo '❌ Failed. See the stage that broke above.' }
  }
}
